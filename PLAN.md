# 체스 앱 개선 계획 및 변경 이력

## 완료된 항목

### 1. 복기 시 최선의 수 추천 ✅
**문제:** 복기 모드에서 수의 등급(실수, 블런더 등)은 표시되지만 "최선의 수가 무엇이었나"를 알 수 없었음.

**구현 내용:**
- `runAnalysis` 내 `bestMovesArr` 배열에 Stockfish `bestmove` 응답을 `{f, t}` 좌표로 저장
- `bestMoves` state에 분석 완료 시 저장, `reset()` 시 초기화
- 복기 중 보드 위에 파란색(`rgba(100,180,255,...)`) SVG 화살표로 최선의 수 표시
  - 힌트 화살표(초록)와 색상 구분
  - `grade === 'best'`이면 화살표 미표시 (이미 최선)
- 수 등급 배지에 "최선: e2→e4" 형태 텍스트 추가

**수정 위치:** `chess-stockfish-engine.jsx` lines ~574, ~620, ~831, ~906

---

### 2. 난이도바 세분화 ✅
**문제:** 기존 10단계(약 200 ELO 간격)가 입문자 구간(600~1200)에서 너무 성겨 원하는 강도 설정 어려움.

**구현 내용:**
- `DIFFS` 배열을 10단계 → 19단계(약 100 ELO 간격)로 확장
  - 600~2400 ELO 커버, `skill` 필드 내장 (0~20)
  - `SF_SKILL` 별도 배열 제거, 단일 소스로 통합
- 슬라이더 `max=9` → `max=18`로 수정, 너비 150→130px
- ELO 직접 입력 필드 추가 (슬라이더와 연동)
  - 포커스 시 현재 ELO 표시, 입력 중 가장 가까운 단계로 실시간 스냅
  - Enter 키로 확정, blur 시 슬라이더 값으로 복귀
- 오프닝 북 임계값 `di>=3` → `di>=6` (~1200 ELO 기준 유지)
- Wally-BOT 부제: `{d.name} · {d.elo}` → `ELO {d.elo} · d{d.depth}`

**수정 위치:** `chess-stockfish-engine.jsx` lines ~241, ~260, ~339, ~459, ~464, ~477, ~785, ~822

---

### 3. 평가 점수 불일치로 인한 오판정 버그 수정 ✅
**문제:** 최선의 수를 뒀음에도 "-0.7점 부정확함"으로 판정되는 경우 발생.

**원인:** Stockfish가 각 포지션을 독립적으로 분석하므로 `evals[i]`와 `evals[i+1]` 간 불일치 가능.
예: 포지션 i 분석 → eval +0.5, 최선의 수 실행 → 포지션 i+1 독립 분석 → eval -0.7
→ cpLoss = 120cp로 잘못 계산.

**수정:** 실제로 둔 수(`histStates[i+1].last`)와 `bestMovesArr[i]`의 from/to 좌표가 일치하면
독립 분석 불일치에 관계없이 `rawLoss = 0`으로 강제.

**수정 위치:** `chess-stockfish-engine.jsx` lines ~610~617

---

### 4. ELO 직접 입력 Enter 미반영 버그 수정 ✅
**문제:** ELO 입력창에 숫자를 직접 타이핑 후 Enter를 눌러도 반영되지 않음. 위아래 버튼만 동작.

**원인:**
- `step={100}` 속성으로 100의 배수가 아닌 값을 브라우저가 invalid로 처리
- Enter 키 핸들러 부재

**수정:**
- `step={100}` → `step={1}`로 변경 (자유 입력 허용)
- `onKeyDown` Enter 핸들러 추가: 입력값을 600~2400 범위로 클램프 후 가장 가까운 단계로 스냅
- `onFocus` 시 텍스트 전체 선택(`e.target.select()`)으로 UX 개선

**수정 위치:** `chess-stockfish-engine.jsx` lines ~789~803

---

### 5. 정교한 ELO 난이도 조절 및 초보자 버그 수정 ✅
**문제:** 기존 100단위 스냅 방식으로는 세밀한 난이도 조절이 불가능했으며, 1320 미만의 점수 입력 시 엔진이 1300점대 수준으로 강하게 두는 문제가 있었음.

**구현 내용:**
- 난이도 관리 방식을 인덱스(`di`)에서 실제 숫자(`elo`) 기반으로 전면 개편 (600~2400 범위, 1단위 조절 가능)
- 1320 ELO 이상: `UCI_LimitStrength` 및 `UCI_Elo` 옵션을 사용하여 엔진 실력을 1단위로 정밀 제어
- 1320 ELO 미만: `UCI_LimitStrength`를 끄고, 기존 `Skill Level (0~20)`과 `depth/time` 제한을 사용하여 인위적으로 난이도를 낮춤 (600점대 등 초보자 난이도 정상 작동)
- AI 턴 `useEffect` 무한 루프 버그 수정 (의존성 배열 정리 및 Ref 기반 접근)

---

### 6. 오프닝 무브 판정 버그 수정 ✅
**문제:** `d4` 등 정석적인 오프닝 수가 Lichess 마스터 DB의 최빈값(예: `e4`)과 다르다는 이유로 '실수'로 분류됨.

**구현 내용:**
- `getOpeningMove`가 단일 UCI 문자열 대신 상위 5개 수의 배열을 반환하도록 수정
- `runAnalysis`에서 사용자가 둔 수가 해당 배열에 포함되면 `bookHits`로 인정 (cpLoss=0 처리)
- AI 대국 시에는 배열의 첫 번째(최빈값) 수를 사용하도록 대응

---

### 7. 캐슬링 기물 증발 버그 수정 ✅
**문제:** 흑으로 컴퓨터가 플레이할 때 퀸사이드 캐슬링(O-O-O) 시 킹이 룩 자리에 가고 룩이 증발하는 버그 발생.

**원인 및 해결:**
- 체스 엔진이 가끔 변칙적인 Chess960 캐슬링 표기법(예: `e8a8`)을 출력하여 내부 좌표 파싱에 오류가 발생함.
- `uciToMove` 함수에서 킹이 2칸 이상 이동할 경우 무조건 표준 캐슬링 목적지(c-file 또는 g-file)로 강제 보정(Normalization)하도록 방어 로직 추가.

---

### 8. 복기 시 Eval Bar 연동 및 UI 전면 개편 (Dark & Neon) ✅
**문제:** 복기 중 형세 파악이 어렵고 리뷰 패널 디자인이 단조로움.

**구현 내용:**
- 복기 모드(`viewIdx`) 시 화살표 이동에 따라 분석 완료된 점수(`analysisEvals`)를 왼쪽 Eval Bar에 실시간 반영
- **Dark & Neon 스타일 적용**:
  - 분석 리포트 패널 배경을 더 어두운 솔리드 블랙(`#111`)으로 변경하고 그림자 효과 추가
  - 리뷰 그래프를 3색 네온 그라데이션 선과 야광 글로우(Glow) 효과로 입체감 있게 개편
  - 무브 등급 배지("최고", "실수" 등)에 반투명 배경과 야광 테두리를 적용하여 가독성과 세련미 극대화
  - 내비게이션 및 제어 버튼 디자인 현대화

---

## 다음 (이번 세션) 진행할 항목 📝

1. **사운드 효과 다시 적용** ✅: 기물 이동, 잡기, 체크, 캐슬링 상황에 맞는 오디오 효과음 추가 (이전에 시도 후 롤백했던 기능 재도전)
2. **PGN 내보내기/불러오기**: 현재 게임 기록을 PGN 형식으로 클립보드에 복사하고, PGN 텍스트를 입력받아 대국을 복원하는 기능 구현
3. **모바일 레이아웃**: 화면 크기에 따른 체스판 및 사이드바 크기 최적화 (반응형 UI)
