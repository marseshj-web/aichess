# 체스 앱 개선 계획 및 변경 이력

## 완료된 항목

### 1. 복기 시 최선의 수 추천 ✅
**문제:** 복기 모드에서 수의 등급(실수, 블런더 등)은 표시되지만 "최선의 수가 무엇이었나"를 알 수 없었음.

**구현 내용:**
- `runAnalysis` 내 `bestMovesArr` 배열에 Stockfish `bestmove` 응답을 `{f, t}` 좌표로 저장
- `bestMoves` state에 분석 완료 시 저장, `reset()` 시 초기화
- 복기 중 보드 위에 파란색(`rgba(100,180,255,...)`) SVG 화살표로 최선의 수 표시
  - 힌트 화살표(초록)와 색상 구분
  - `grade === 'best'`이면 화살표 미표시 (이미 최선)
- 수 등급 배지에 "최선: e2→e4" 형태 텍스트 추가

**수정 위치:** `chess-stockfish-engine.jsx` lines ~574, ~620, ~831, ~906

---

### 2. 난이도바 세분화 ✅
**문제:** 기존 10단계(약 200 ELO 간격)가 입문자 구간(600~1200)에서 너무 성겨 원하는 강도 설정 어려움.

**구현 내용:**
- `DIFFS` 배열을 10단계 → 19단계(약 100 ELO 간격)로 확장
  - 600~2400 ELO 커버, `skill` 필드 내장 (0~20)
  - `SF_SKILL` 별도 배열 제거, 단일 소스로 통합
- 슬라이더 `max=9` → `max=18`로 수정, 너비 150→130px
- ELO 직접 입력 필드 추가 (슬라이더와 연동)
  - 포커스 시 현재 ELO 표시, 입력 중 가장 가까운 단계로 실시간 스냅
  - Enter 키로 확정, blur 시 슬라이더 값으로 복귀
- 오프닝 북 임계값 `di>=3` → `di>=6` (~1200 ELO 기준 유지)
- Wally-BOT 부제: `{d.name} · {d.elo}` → `ELO {d.elo} · d{d.depth}`

**수정 위치:** `chess-stockfish-engine.jsx` lines ~241, ~260, ~339, ~459, ~464, ~477, ~785, ~822

---

### 3. 평가 점수 불일치로 인한 오판정 버그 수정 ✅
**문제:** 최선의 수를 뒀음에도 "-0.7점 부정확함"으로 판정되는 경우 발생.

**원인:** Stockfish가 각 포지션을 독립적으로 분석하므로 `evals[i]`와 `evals[i+1]` 간 불일치 가능.
예: 포지션 i 분석 → eval +0.5, 최선의 수 실행 → 포지션 i+1 독립 분석 → eval -0.7
→ cpLoss = 120cp로 잘못 계산.

**수정:** 실제로 둔 수(`histStates[i+1].last`)와 `bestMovesArr[i]`의 from/to 좌표가 일치하면
독립 분석 불일치에 관계없이 `rawLoss = 0`으로 강제.

**수정 위치:** `chess-stockfish-engine.jsx` lines ~610~617

---

### 4. ELO 직접 입력 Enter 미반영 버그 수정 ✅
**문제:** ELO 입력창에 숫자를 직접 타이핑 후 Enter를 눌러도 반영되지 않음. 위아래 버튼만 동작.

**원인:**
- `step={100}` 속성으로 100의 배수가 아닌 값을 브라우저가 invalid로 처리
- Enter 키 핸들러 부재

**수정:**
- `step={100}` → `step={1}`로 변경 (자유 입력 허용)
- `onKeyDown` Enter 핸들러 추가: 입력값을 600~2400 범위로 클램프 후 가장 가까운 단계로 스냅
- `onFocus` 시 텍스트 전체 선택(`e.target.select()`)으로 UX 개선

**수정 위치:** `chess-stockfish-engine.jsx` lines ~789~803

---

## 미완료 항목

### 오프닝 무브 판정 버그 (d4 등이 실수로 분류되는 문제)
- 오프닝 수가 실수/부정확함으로 잘못 분류되는 케이스 재현 및 원인 분석 필요
- `bookHits` 배열 로직과 Lichess API 응답 처리 부분 검토 예정
